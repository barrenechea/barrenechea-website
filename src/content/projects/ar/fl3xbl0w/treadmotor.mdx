---
title: وحدة تحكم محرك جهاز المشي - fl3xbl0w
description: مشروع هندسة عكسية. بدأ مع جهاز المشي Bowflex 22 لكنه أصبح عامًا لأي جهاز يعمل بنظام أندرويد تبيعه شركة Nautilus Inc. (Nautilus، Bowflex، Schwinn).
pubDate: 2022-05-28T10:28:00Z
link: /ar/projects/fl3xbl0w
img: ~/assets/images/project-fl3xbl0w.svg
imgAlt: شعار مشروع fl3xbl0w
tags:
  - ReverseEngineering
  - Hardware
  - Android
translatedBy: o1-mini
checksum: c18c0dcfb1526f0210709098ca91e330b03d146e571843fc34a705fb31a09e26
---

import { Image } from 'astro:assets';
import B017D from '~/assets/images/fl3xbl0w/b017d.jpg';
import TreadmillElectrical from '~/assets/images/fl3xbl0w/treadmill-electrical.png';
import TreadmillComm from '~/assets/images/fl3xbl0w/treadmill-comm.png';
import Molex from '~/assets/images/fl3xbl0w/molex.jpg';
import UARTSniffing from '~/assets/images/fl3xbl0w/uart-sniffing.png';

_هذا ينطبق بشكل أساسي على جهاز المشي 22 وجهاز المشي 56._

لوحة التحكم في المحرك مُصنعة من قبل [Electronics Way Industry](https://web.archive.org/web/20231228174313/https://www.ewayindustry.com/ew-dc-b017.html).

<Image src={B017D} alt="لوحة تحكم المحرك B017D" format="webp" />

بالنظر إلى [دليل الخدمة](https://download.nautilus.com/supportdocs/AM_OM/Bowflex/BFX.T10.T22.T25.T56.SM.EN.pdf) المقدم من شركة Nautilus Inc. ([نسخة احتياطية على archive.org](https://web.archive.org/web/20220409140737/https://download.nautilus.com/supportdocs/AM_OM/Bowflex/BFX.T10.T22.T25.T56.SM.EN.pdf)):

<Image src={TreadmillElectrical} alt="الرسم التخطيطي الكهربائي لجهاز المشي" format="webp" />

التركيز بشكل خاص على هذا الجزء:

<Image src={TreadmillComm} alt="مسار الاتصال في جهاز المشي" format="webp" />

يمكننا تحديد "كابل الاتصال" الذي يربط وحدة التحكم في المحرك ككابل بـ 5 دبابيس. هناك موصل واحد فقط بـ 5 دبابيس.
لقد قمت بتسمية الكابلات بألوانها المقابلة (البيانات والمفتاح معزولين بصريًا):

| لون الكابل | التسمية |
| ---------- | ------- |
| الأحمر     | GND     |
| الأبيض     | RXD     |
| الأسود     | TXD     |
| الأصفر     | +12     |
| الأخضر     | SW      |

اللوحة غير متصلة مباشرة بوحدة التحكم Android.

الموصل الوحيد بـ 5 دبابيس هو من شركة Molex. بحثت في جوجل عن "small Molex connectors" ووجدت صورة لما يسمى `Molex Micro-Fit 3.0 Single Row (5-Pin)`, والذي يُستخدم لتوصيل لوحة التحكم في المحرك:

<Image src={Molex} alt="موصل Molex Micro-Fit 3.0" format="webp" />

[رابط علي إكسبريس](https://aliexpress.com/item/32902205579.html)

من خلال النظر في `NautilusLauncher.apk` باستخدام `jadx-gui`، أستطيع أن أرى أنهم يتواصلون بين جهاز Android اللوحي و"وحدة التحكم الشاملة" باستخدام اتصال تسلسلي بسرعة 230400 Baud (باستخدام `/dev/ttyS4`). هذا ليس ما نقوم بتحليله هنا. هذا يشير إلى الاتصال بين Android و"وحدة التحكم الشاملة". نحن نبحث في الاتصال بين "وحدة تحكم لوحة الأزرار" و"لوحة تحكم المحرك"، وبالتالي نستبعد ثلاث لوحات كأماكن محتملة للفشل.

محاولة توصيل جسر تسلسلي يعتمد على ESP32 أو CH340 مباشرة بالكابلات بين قاعدة جهاز المشي ولوحة تحكم Bowflex تسببت في عدم تهيئة قاعدة جهاز المشي بشكل صحيح، وبعد ذلك حصلت على محلل منطق لمزيد من التحقيق.

## تحديث 2025

في الأسابيع الأخيرة، وبعد حوالي عامين من بدأت بهذا المشروع، اتصل بي عدة أشخاص للاستفسار عن التقدم في هذا الموضوع، مما أكد افتراضي الأولي بأن نظام جهاز المشي سيء وأنه كان مسألة وقت قبل أن تبدأ الأجهزة بالتعطل. بدا وقتًا مناسبًا لاستخدام محلل المنطق الخاص بي، الذي كان حتى الآن يجمع الغبار فقط.

بتوصيل محلل المنطق بخطوط TXD و RXD (وGND، بالطبع)، تمكنت على الفور من بدء اعتراض الرسائل بين الطرفين دون مقاطعة الاتصال. أفترض أنني في البداية لم أتمكن من استخدام ESP32 بسبب مشاكل في المقاومة. بعد بضع دقائق من التجربة والخطأ، توصلت إلى تكوين التسلسلي التالي:

```c
- 2400 Baud
- 8 Bits per Frame
- 1 Stop Bit
- No Parity Bit
- Least Significant Bit Sent First
- TXD: Inverted Signal
- RXD: Non Inverted Signal
```

بهذه الإعدادات، استطعت رؤية الرسائل المحددة بوضوح.

<div align="center">
  <Image src={UARTSniffing} alt="اعتراض رسائل UART" format="webp" />
  <p class="italic">اعتراض رسائل UART أثناء عملية الإقلاع</p>
</div>

بعض الأشياء التي لاحظتها على الفور:

- جميع الرسائل المرسلة من لوحة الأزرار تبدأ بـ `0x68`
- جميع الرسائل المرسلة من لوحة تحكم المحرك تبدأ بـ `0x73`
- الرسائل من الطرفين تنتهي بـ `0x43`
- بشكل عام، تُرسل الرسائل من لوحة الأزرار بعد 100 مللي ثانية من تلقي رسالة من لوحة تحكم المحرك
  - باستثناء أثناء عملية الإقلاع، حيث يوجد فرق بمقدار 300 مللي ثانية في حالة واحدة
- الضوضاء على خطوط الاتصال هائلة، مما يجعل قراءة الرسائل صعبة

بناءً على ذلك، يبدأ عملية فك شيفرة الرسائل وفهم ما يتم التواصل به بين الطرفين، مما يسمح بإجراء تغييرات محكومة في روتين التمرين.

### اعتراض تغييرات السرعة

من خلال إجراء تغييرات محكومة على سرعات محددة، يمكن ملاحظة القيم التالية المرسلة إلى لوحة تحكم المحرك:

| السرعة على الشاشة                     | الرسالة المرسلة                                     |
| ------------------------------------- | --------------------------------------------------- |
| 0.0 كم/س (في حالة الانتظار أو التوقف) | `0x68 0x08 0x80 0x50 0x00 0x0A 0x00 0x00 0xE2 0x43` |
| 2.0 كم/س                              | `0x68 0x08 0x80 0x50 0x14 0x0A 0x00 0x00 0xF6 0x43` |
| 3.0 كم/س                              | `0x68 0x08 0x80 0x50 0x1D 0x0A 0x00 0x00 0xFF 0x43` |
| 5.0 كم/س                              | `0x68 0x08 0x80 0x50 0x31 0x0A 0x00 0x00 0x13 0x43` |

يمكن ملاحظة أن البايت الخامس والبايت التاسع يتغيران. يبدو أن البايت الخامس هو السرعة بالهكسادسيميل، والبايت التاسع يبدو أنه تحقق.

تحويل قيم البايت الخامس إلى عشرية:

| السرعة على الشاشة                     | هكسادسيميل | عشري |
| ------------------------------------- | ---------- | ---- |
| 0.0 كم/س (في حالة الانتظار أو التوقف) | 0x00       | 0    |
| 2.0 كم/س                              | 0x14       | 20   |
| 3.0 كم/س                              | 0x1D       | 29   |
| 5.0 كم/س                              | 0x31       | 49   |

بعد أن فككت بعض أجزاء نظام Android منذ سنوات، تذكرت أنه عند تكوين الجهاز في النظام المتري، يقوم تطبيق Bowflex داخليًا بتحويل من النظام المتري إلى الإمبراطوري للتواصل مع "UCB". يبدو أن لوحة تحكم المحرك تستخدم النظام المتري، ومن الواضح أن هناك فقدانًا للدقة في التحويل من النظام المتري إلى الإمبراطوري ثم العودة إلى النظام المتري (وهو ما تتوقعه لوحة تحكم المحرك)، نظرًا لأن كل شيء يُعالج بدقة عشرية واحدة. **هل كان من الصعب القيام بذلك بشكل صحيح، Nautilus؟**

بالنظر إلى ذلك، وإذا تم تطبيق عامل تكبير بمقدار 10، فإنه يتطابق تمامًا مع القيم المرسلة إلى لوحة تحكم المحرك. لذا، ستكون الصيغة:

```
Decimal value = Speed in km/h × 10
```

### اعتراض تغييرات الميول

باتباع نفس العملية كما في السرعة، يمكن ملاحظة القيم التالية المرسلة إلى لوحة تحكم المحرك:

| الميول على الشاشة | الرسالة المرسلة                                     |
| ----------------- | --------------------------------------------------- |
| -5°               | `0x68 0x08 0x80 0x50 0x1D 0x00 0x00 0x00 0xF5 0x43` |
| 0°                | `0x68 0x08 0x80 0x50 0x1D 0x32 0x00 0x00 0x27 0x43` |
| 9°                | `0x68 0x08 0x80 0x50 0x1D 0x8C 0x00 0x00 0x81 0x43` |

في هذه الحالة، يبدو أن البايت السادس هو الميول بالهكسادسيميل، ويؤكد أن البايت التاسع هو تحقق.

تحويل قيم البايت السادس إلى عشرية:

| الميول على الشاشة | هكسادسيميل | عشري |
| ----------------- | ---------- | ---- |
| -5°               | 0x00       | 0    |
| 0°                | 0x32       | 50   |
| 9°                | 0x8C       | 140  |

الصيغة التي تتطابق تمامًا مع القيم المرسلة إلى لوحة تحكم المحرك هي:

```
Decimal value = (Angle + 5) × 10
```

### التحقق

يبدو أن هذا تحقق بسيط ومعيار في المتحكمات الدقيقة، حيث يتم جمع جميع بايتات الرسالة ويتسبب في تجاوز الحد عند الوصول إلى 256. سيكون التمثيل البسيط شيئًا مثل:

```c
uint8_t calculateChecksum(uint8_t *msg) {
  return msg[1] + msg[2] + msg[3] + msg[4] + msg[5] + msg[6] + msg[7];
}
```

باستخدام `uint8_t` كنوع العودة، يحدث التجاوز بشكل طبيعي. يمكن استخدام `for loop` لجمع القيم وإرجاع `sum % 256`، لكن ذلك سيكون أبطأ للمتحكمات الدقيقة دون أي فائدة حقيقية.

### الخطوات التالية

- اكتساب فهم منطقي لعملية الإقلاع، أو على الأقل تكرارها
- اعتراض التفاعلات مع مفتاح الأمان (الشيء الأحمر الذي يتم وضعه على الملابس)
- تفسير الرسائل المرسلة من لوحة تحكم المحرك، والتي لا ينبغي أن تختلف كثيرًا عن الرسائل المرسلة من لوحة الأزرار

بهذا، يمكن تكرار وظيفة لوحة الأزرار، وبالتالي يمكن التحكم في جهاز المشي من متحكم دقيق.

<div align="center">
  <p class="italic">-- يستمر --</p>
</div>
